# NOTE: this integration only works with Flex versions 1.3.4 and abobe
#
# Flex has a limit of 500 events per execution.  If you are generating more than
# 500 Transactions every 15 seconds, then you should "shard" instances of this integration
# by running several in parallel, adding a filter to the payload query on each 
# to split the volume of transactions across them.
---
integrations:
  - name: nri-flex
    interval: 1m
    timeout: 5s
    config:
      name: elastic-apm-transaction
      global:
        base_url: http://localhost:9200/
        # user: elastic
        # pass: elastic
        headers:
          accept: application/json
          # tls_config:
          #   enable: true
          #   ca: /etc/bundles/my-ca-cert.pem
      apis:
        # pull recent events from elasticsearch
        # be sure that the difference in the range filter on `event.ingested` matches the
        # interval of the integration. 
        - name: elastic-apm-transaction-events
          event_type: ElasticApmTransaction
          url: apm-*-transaction-*/_search
          method: POST

          payload: >
            {
              "size": 498,
              "query": {
                "bool": {
                  "must": [
                    {
                      "match_all": {}
                    }
                  ],
                  "filter": [
                    {
                      "range": {
                        "event.ingested": {
                          "gte": "now-1m",
                          "lt": "now"
                        }
                      }
                    }
                  ],
                  "should": [],
                  "must_not": []
                }
              },
              "docvalue_fields": [
                {
                  "field": "@timestamp",
                  "format": "epoch_millis"
                }
              ]
            }
          jq: '.hits.hits | map(._source + { "es.index": ._index,  "es.doc.id": ._id, "timestamp": .fields["@timestamp"][0] })'
          lazy_flatten:
            - http
        
        # re-use the response to record the metadata of the request in a separate event.
        # the number of hits in this event should equal the number of inserted 
        # `ElasticApmTransaction` events as reported by the `flexStatusSample` 
        - name: elastic-apm-transaction-status
          event_type: ElasticApmTransactionStatus
          cache: apm-*-transaction-*/_search
          jq: '| { "shards": ._shards } + delpaths([["hits", "hits"],["_shards"]])'

